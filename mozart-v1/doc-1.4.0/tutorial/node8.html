<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>8 Concurrency</TITLE><LINK href="ozdoc.css" rel="stylesheet" type="text/css"></HEAD><BODY><TABLE align="center" border="0" cellpadding="6" cellspacing="6" class="nav"><TR bgcolor="#DDDDDD"><TD><A href="node7.html#chapter.modules">&lt;&lt; Prev</A></TD><TD><A href="index.html">- Up -</A></TD><TD><A href="node9.html#chapter.stateful">Next &gt;&gt;</A></TD></TR></TABLE><DIV id="chapter.concurrency"><H1><A name="chapter.concurrency">8 Concurrency</A></H1><P>So far, we have seen only one thread executing. It is time to introduce concurrency. In Oz a new concurrent thread of control is spawned by: </P><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">thread</SPAN>&nbsp;</CODE><I>S</I><CODE>&nbsp;<SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><P> </P><P>Executing this statement, a thread is forked that runs concurrently with the current thread. The current thread resumes immediately with the next statement. Each nonterminating thread, that is not blocking, will eventually be allocated a time slice of the processor. This means that threads are executed fairly. </P><P>However, there are three priority levels: <EM>high</EM>, <EM>medium</EM>, and <EM>low</EM> that determine how often a runnable thread is allocated a time slice. In Oz, a high priority thread cannot starve a low priority one. Priority determines only how large piece of the processor cake a thread can get. </P><P>Each thread has a unique name. To get the name of the current thread the procedure <CODE>Thread<SPAN class="keyword">.</SPAN>this<SPAN class="keyword">/</SPAN>1</CODE> is called. Having a reference to a thread, by using its name, enables operations on threads such as terminating a thread, or raising an exception in a thread. Thread operations are defined the base module <CODE>Thread</CODE>. </P><P>Let us see what we can do with threads. First, remember that each thread is a data-flow thread that blocks on data dependency. Consider the following program: </P><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">declare</SPAN>&nbsp;X0&nbsp;X1&nbsp;X2&nbsp;X3&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR><SPAN class="keyword">thread</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">local</SPAN>&nbsp;Y0&nbsp;Y1&nbsp;Y2&nbsp;Y3&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Browse&nbsp;[Y0&nbsp;Y1&nbsp;Y2&nbsp;Y3]}&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y0&nbsp;=&nbsp;X0<SPAN class="keyword">+</SPAN>1<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y1&nbsp;=&nbsp;X1<SPAN class="keyword">+</SPAN>Y0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y2&nbsp;=&nbsp;X2<SPAN class="keyword">+</SPAN>Y1<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y3&nbsp;=&nbsp;X3<SPAN class="keyword">+</SPAN>Y2<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Browse&nbsp;completed}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR>{Browse&nbsp;[X0&nbsp;X1&nbsp;X2&nbsp;X3]}</CODE></BLOCKQUOTE><P> </P><P>If you input this program and watch the display of the Browser tool, the variables will appear unbound. Observe now what happens when you input the following statements one at a time: </P><BLOCKQUOTE class="code"><CODE>X0&nbsp;=&nbsp;0<BR>X1&nbsp;=&nbsp;1<BR>X2&nbsp;=&nbsp;2<BR>X3&nbsp;=&nbsp;3</CODE></BLOCKQUOTE><P> </P><P>You will see how the thread resumes and then suspends again. First when <CODE>X0</CODE> is bound the thread can execute <CODE>Y0&nbsp;=&nbsp;X0<SPAN class="keyword">+</SPAN>1</CODE> and suspends again because it needs the value of <CODE>X1</CODE> while executing <CODE>Y1&nbsp;=X1<SPAN class="keyword">+</SPAN>Y0<SPAN class="keyword">,</SPAN></CODE> and so on. </P><P></P><DIV class="figure" id="concurrentmap"><HR><P><A name="concurrentmap"></A></P></DIV><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">fun</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Map</SPAN>&nbsp;Xs&nbsp;F}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;Xs<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;nil<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;X<SPAN class="keyword">|</SPAN>Xr&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{F&nbsp;X}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<SPAN class="keyword">|</SPAN>{Map&nbsp;Xr&nbsp;F}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><DIV class="figure"><P class="caption"><STRONG>Figure&nbsp;8.1:</STRONG> A concurrent Map function</P><HR></DIV><P> </P><P>The program shown in <A href="node8.html#concurrentmap">Figure&nbsp;8.1</A> defines a concurrent <CODE>Map</CODE> function. Notice that <CODE><SPAN class="keyword">thread</SPAN>&nbsp;<SPAN class="keyword">...</SPAN>&nbsp;<SPAN class="keyword">end</SPAN></CODE> is used here as an expression. Let us discuss the behavior of this program. If we enter the following statements: </P><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">declare</SPAN>&nbsp;<BR>F&nbsp;X&nbsp;Y&nbsp;Z<BR>{Browse&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Map&nbsp;X&nbsp;F}&nbsp;<SPAN class="keyword">end</SPAN>}</CODE></BLOCKQUOTE><P> </P><P>a thread executing <CODE>Map</CODE> is created. It will suspend immediately in the case-statement because <CODE>X</CODE> is unbound. If we thereafter enter the following statements: </P><BLOCKQUOTE class="code"><CODE>X&nbsp;=&nbsp;1<SPAN class="keyword">|</SPAN>2<SPAN class="keyword">|</SPAN>Y<BR><SPAN class="keyword">fun</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">F</SPAN>&nbsp;X}&nbsp;X<SPAN class="keyword">*</SPAN>X&nbsp;<SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><P> </P><P>the main thread will traverse the list creating two threads for the first two arguments of the list, <CODE><SPAN class="keyword">thread</SPAN>&nbsp;{F&nbsp;1}&nbsp;<SPAN class="keyword">end</SPAN></CODE>, and <CODE><SPAN class="keyword">thread</SPAN>&nbsp;{F&nbsp;2}&nbsp;<SPAN class="keyword">end</SPAN></CODE>, and then it will suspend again on the tail of the list <CODE>Y</CODE>. Finally, </P><BLOCKQUOTE class="code"><CODE>Y&nbsp;=&nbsp;3<SPAN class="keyword">|</SPAN>Z<BR>Z&nbsp;=&nbsp;nil</CODE></BLOCKQUOTE><P> </P><P>will complete the computation of the main thread and the newly created thread <CODE><SPAN class="keyword">thread</SPAN>&nbsp;{F&nbsp;3}&nbsp;<SPAN class="keyword">end</SPAN></CODE>, resulting in the final list <CODE>[1&nbsp;4&nbsp;9]</CODE>. </P><P>The program shown in <A href="node8.html#concurrentfib">Figure&nbsp;8.2</A> is a concurrent divide-and-conquer program, which is rather inefficient way to compute the <EM>Fibonacci</EM> function. This program creates an exponential number of threads! See how easy it is to create concurrent threads. You may use this program to test how many threads your Oz installation can create. Try </P><BLOCKQUOTE class="code"><CODE>{Browse&nbsp;{Fib&nbsp;25}}</CODE></BLOCKQUOTE><P> </P><P>while using the panel program in your Oz menu to see the threads. If it works, try a larger number. The panel is show in <A href="node8.html#threads">Figure&nbsp;8.3</A>. </P><P></P><DIV class="figure" id="concurrentfib"><HR><P><A name="concurrentfib"></A></P></DIV><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">fun</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Fib</SPAN>&nbsp;X}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;X<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;0&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;1<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;1&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;1<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Fib&nbsp;X<SPAN class="keyword">-</SPAN>1}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;<SPAN class="keyword">+</SPAN>&nbsp;{Fib&nbsp;X<SPAN class="keyword">-</SPAN>2}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><DIV class="figure"><P class="caption"><STRONG>Figure&nbsp;8.2:</STRONG> A concurrent Fibonacci function</P><HR></DIV><P> </P><P></P><DIV class="figure" id="threads"><HR><P><A name="threads"></A></P></DIV><DIV align="center"><IMG alt="" src="thread.gif"></DIV><DIV class="figure"><P class="caption"><STRONG>Figure&nbsp;8.3:</STRONG> The Mozart Panel showing thread creation <CODE>{Fib&nbsp;26&nbsp;X}</CODE></P><HR></DIV><P> </P><P>The whole idea of explicit thread creation in Oz is to enable the programmer to structure his/her application in a modular way. In this respect the Mozart system is excellent. Threads are so cheap that can afford to create say 100000 of them. As a comparison thread creation in Mozart 1.0 is about 60 time faster than in Java JDK 1.2. If concurrency makes an easier structure of you program then use it without hesitation. However sequential programs are always faster than concurrent programs having the same structure. The <CODE>Fib</CODE> program in <A href="node8.html#concurrentfib">Figure&nbsp;8.2</A> is faster if you remove <CODE><SPAN class="keyword">thread</SPAN>&nbsp;<SPAN class="keyword">...</SPAN>&nbsp;<SPAN class="keyword">end</SPAN></CODE>. Therefore, create threads only when the application needs it, and not because concurrency is fun. </P><DIV id="section.concurrency.time"><H2><A name="section.concurrency.time">8.1 Time</A></H2><P>In module <A href="../base/time.html#section.control.time"><CODE>Time</CODE></A>, we can find a number of useful soft real-time procedures. Among them are: </P><UL><LI><P><CODE>{Alarm&nbsp;I&nbsp;?U}</CODE> which creates immediately its own thread, and binds <CODE>U</CODE> to <CODE><SPAN class="keyword">unit</SPAN></CODE> after <CODE>I</CODE> milliseconds. </P></LI><LI><P><CODE>{Delay&nbsp;I}</CODE> suspends the executing thread for, a least, <CODE>I</CODE> milliseconds and then reduces to <CODE><SPAN class="keyword">skip</SPAN></CODE>. </P></LI></UL><P> </P><P></P><DIV class="figure" id="pingpong"><HR><P><A name="pingpong"></A></P></DIV><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">local</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Ping</SPAN>&nbsp;N}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;N<SPAN class="keyword">==</SPAN>0&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Browse&nbsp;<SPAN class="string">'ping&nbsp;terminated'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;{Delay&nbsp;500}&nbsp;{Browse&nbsp;ping}&nbsp;{Ping&nbsp;N<SPAN class="keyword">-</SPAN>1}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Pong</SPAN>&nbsp;N}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{For&nbsp;1&nbsp;N&nbsp;1&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;I}&nbsp;{Delay&nbsp;600}&nbsp;{Browse&nbsp;pong}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Browse&nbsp;<SPAN class="string">'pong&nbsp;terminated'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{Browse&nbsp;<SPAN class="string">'game&nbsp;started'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Ping&nbsp;50}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Pong&nbsp;50}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><DIV class="figure"><P class="caption"><STRONG>Figure&nbsp;8.4:</STRONG> A 'Ping Pong' program</P><HR></DIV><P> </P><P>The program shown in <A href="node8.html#pingpong">Figure&nbsp;8.4</A> starts two threads, one displays <CODE>ping</CODE> periodically after 500 milliseconds, and the other <CODE>pong</CODE> after 600 milliseconds. Some <CODE>pings</CODE> will be displayed immediately after each other because of the periodicity difference. </P><H3><A name="label48">8.1.1 Making Standalone Application</A></H3><P>It is easy to make stand-alone applications in Mozart. We show this by make the program in <A href="node8.html#pingpong">Figure&nbsp;8.4</A> stand-alone by making a functor of the program as shown in <A href="node8.html#pingpong1">Figure&nbsp;8.5</A>, and storing it in your file <CODE>PingPong<SPAN class="keyword">.</SPAN>oz</CODE>. Thereafter use the command: </P><BLOCKQUOTE class="code"><CODE>&nbsp;ozc&nbsp;<SPAN class="keyword">-</SPAN>x&nbsp;PingPong<SPAN class="keyword">.</SPAN>oz&nbsp;</CODE></BLOCKQUOTE><P></P><P> Now type PingPong in your shell to start the program.<A href="node8.html#label50"><SUP>1</SUP></A></P><P></P><DIV class="figure" id="pingpong1"><HR><P><A name="pingpong1"></A></P></DIV><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">functor</SPAN>&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Browser(browse:Browse)&nbsp;%<SPAN class="comment">Import&nbsp;Browse&nbsp;form&nbsp;Browser&nbsp;module<BR></SPAN><SPAN class="keyword">define</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Ping</SPAN>&nbsp;N}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;N<SPAN class="keyword">==</SPAN>0&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Browse&nbsp;<SPAN class="string">'ping&nbsp;terminated'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;{Delay&nbsp;500}&nbsp;{Browse&nbsp;ping}&nbsp;{Ping&nbsp;N<SPAN class="keyword">-</SPAN>1}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Pong</SPAN>&nbsp;N}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{For&nbsp;1&nbsp;N&nbsp;1&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;I}&nbsp;{Delay&nbsp;600}&nbsp;{Browse&nbsp;pong}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Browse&nbsp;<SPAN class="string">'pong&nbsp;terminated'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{Browse&nbsp;<SPAN class="string">'game&nbsp;started'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Ping&nbsp;50}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Pong&nbsp;50}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><DIV class="figure"><P class="caption"><STRONG>Figure&nbsp;8.5:</STRONG> A 'Ping Pong' program stand-alone</P><HR></DIV><P> </P></DIV><DIV id="section.concurrency.stream"><H2><A name="section.concurrency.stream">8.2 Stream Communication</A></H2><P>The data-flow property of Oz easily enables writing threads that communicate through streams in a producer-consumer pattern. A stream is a list that is created incrementally by one thread (the producer) and subsequently consumed by one or more threads (the consumers). The threads consume the same elements of the stream. For example, the program in <A href="node8.html#sumelements">Figure&nbsp;8.6</A> is an example of stream communication, where the producer generates a list of numbers and the consumer sums all the numbers. </P><P></P><DIV class="figure" id="sumelements"><HR><P><A name="sumelements"></A></P></DIV><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">fun</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Generator</SPAN>&nbsp;N}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;N&nbsp;<SPAN class="keyword">&gt;</SPAN>&nbsp;0&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;N<SPAN class="keyword">|</SPAN>{Generator&nbsp;N<SPAN class="keyword">-</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;nil&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">local</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">fun</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Sum1</SPAN>&nbsp;L&nbsp;A}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;L<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;A<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;X<SPAN class="keyword">|</SPAN>Xs&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Sum1&nbsp;Xs&nbsp;A<SPAN class="keyword">+</SPAN>X}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">in</SPAN>&nbsp;<SPAN class="keyword">fun</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Sum</SPAN>&nbsp;L}&nbsp;{Sum1&nbsp;L&nbsp;0}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><DIV class="figure"><P class="caption"><STRONG>Figure&nbsp;8.6:</STRONG> Summing the elements in a list</P><HR></DIV><P> </P><P>Try the program above by running the following program: </P><BLOCKQUOTE class="code"><CODE>{Browse&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Sum&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Generator&nbsp;150000}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;}&nbsp;<SPAN class="keyword">end</SPAN>}</CODE></BLOCKQUOTE><P> </P><P>It should produce the number <CODE>11250075000</CODE>. Let us understand the working of stream communication. A producer incrementally creates a stream (a list) of elements as in the following example where it is producing volvo's. This happens in general in an eager fashion. </P><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">fun</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Producer</SPAN>&nbsp;<SPAN class="keyword">...</SPAN>}&nbsp;<SPAN class="keyword">...</SPAN>&nbsp;volvo<SPAN class="keyword">|</SPAN>{Producer&nbsp;<SPAN class="keyword">...</SPAN>}&nbsp;<SPAN class="keyword">...</SPAN>&nbsp;<SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><P> </P><P>The consumer waits on the stream until items arrive, then the items are consumed as in: </P><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Consumer</SPAN>&nbsp;Ls&nbsp;<SPAN class="keyword">...</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;Ls&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;volvo<SPAN class="keyword">|</SPAN>Lr&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;</CODE><I>'Consume volvo'</I><CODE>&nbsp;<SPAN class="keyword">...</SPAN>&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{Consumer&nbsp;Lr}<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><P> </P><P>The data-flow behavior of the <EM>case-statement</EM> suspends the consumer until the arrival of the next item of the stream. The recursive call allows the consumer to iterate the action over again. The following pattern avoids the use of recursion by using an iterator instead: </P><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Consumer</SPAN>&nbsp;Ls&nbsp;<SPAN class="keyword">...</SPAN>}<BR>&nbsp;&nbsp;&nbsp;{ForAll&nbsp;Ls<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;Item}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;Item&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;volvo&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><I>Consume volvo</I><CODE>&nbsp;<SPAN class="keyword">...</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>}<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><P> </P><P><A href="node8.html#volvos">Figure&nbsp;8.7</A> shows a simple example using this pattern. The consumer counts the cars received. Each time it receives <CODE>1000</CODE> cars it prints a message on the display of the Browser. </P><P></P><DIV class="figure" id="volvos"><HR><P><A name="volvos"></A></P></DIV><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">fun</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Producer</SPAN>&nbsp;N}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;N&nbsp;<SPAN class="keyword">&gt;</SPAN>&nbsp;0&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;volvo<SPAN class="keyword">|</SPAN>{Producer&nbsp;N<SPAN class="keyword">-</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;nil&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">local</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">ConsumerN</SPAN>&nbsp;Ls&nbsp;N}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;Ls&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;volvo<SPAN class="keyword">|</SPAN>Lr&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;N&nbsp;<SPAN class="keyword">mod</SPAN>&nbsp;1000&nbsp;<SPAN class="keyword">==</SPAN>&nbsp;0&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Browse&nbsp;<SPAN class="string">'riding&nbsp;a&nbsp;new&nbsp;volvo'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ConsumerN&nbsp;Lr&nbsp;N<SPAN class="keyword">+</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ConsumerN&nbsp;{List<SPAN class="keyword">.</SPAN>drop&nbsp;Ls&nbsp;1}&nbsp;N}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Consumer</SPAN>&nbsp;Ls}&nbsp;{ConsumerN&nbsp;Ls&nbsp;1}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><DIV class="figure"><P class="caption"><STRONG>Figure&nbsp;8.7:</STRONG> Producing volvo's</P><HR></DIV><P> </P><P>You may run this program using: </P><BLOCKQUOTE class="code"><CODE>{Consumer&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Producer&nbsp;10000}&nbsp;<SPAN class="keyword">end</SPAN>}</CODE></BLOCKQUOTE><P> </P><P class="warning"><STRONG>Warning:</STRONG>When you feed a statement into the emulator, it is executed in its own thread. Therefore, after feeding the above statement two threads are created. The main one is for the consumer, and the forked thread is for the producer. </P><P>Notice that the consumer was written using the <EM>recursive</EM> pattern. Can we write this program using the iterative <CODE>ForAll<SPAN class="keyword">/</SPAN>2</CODE> construct? This is not possible because the consumer carries an extra argument <I>N</I> that accumulates a result which, is passed to the next recursive call. The argument corresponds to some kind of <EM>state</EM>. In general, there are two solutions. We either introduce a stateful (mutable) data structure, which we will do in <A href="node9.html#section.stateful.cell">Section&nbsp;9.4</A>, or define another iterator that passes the state around. In our case, some iterators that fit our needs exist in the module <CODE>List</CODE>. First, we need an iterator that filters away all items except volvo's. We can use <CODE>{Filter&nbsp;Xs&nbsp;P&nbsp;?Ys}</CODE> which outputs in <CODE>Ys</CODE> all the elements that satisfies the procedure <CODE>P<SPAN class="keyword">/</SPAN>2</CODE> used as a Boolean function. The second construct is <CODE>{List<SPAN class="keyword">.</SPAN>forAllInd&nbsp;Xs&nbsp;P}</CODE> which is similar to <CODE>ForAll</CODE>, but <CODE>P<SPAN class="keyword">/</SPAN>2</CODE> takes the index of the current element of the list, starting from <CODE>1</CODE>, as its first argument, and the element of the list as its second argument. Here is the program: </P><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Consumer</SPAN>&nbsp;Ls}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">fun</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">IsVolvo</SPAN>&nbsp;X}&nbsp;X&nbsp;<SPAN class="keyword">==</SPAN>&nbsp;volvo&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Ls1<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;Ls1&nbsp;=&nbsp;{Filter&nbsp;Ls&nbsp;IsVolvo}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{List<SPAN class="keyword">.</SPAN>forAllInd&nbsp;Ls1<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;N&nbsp;X}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;N&nbsp;<SPAN class="keyword">mod</SPAN>&nbsp;1000&nbsp;<SPAN class="keyword">==</SPAN>&nbsp;0&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Browse&nbsp;<SPAN class="string">'riding&nbsp;a&nbsp;new&nbsp;volvo'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>}<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><P> </P></DIV><DIV id="section.concurrency.priority"><H2><A name="section.concurrency.priority">8.3 Thread Priority and Real Time</A></H2><P>Try to run the program using the following statement: </P><BLOCKQUOTE class="code"><CODE>{Consumer&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Producer&nbsp;5000000}&nbsp;<SPAN class="keyword">end</SPAN>}</CODE></BLOCKQUOTE><P> </P><P>Switch on the panel and observe the memory behavior of the program. You will quickly notice that this program does not behave well. The reason has to do with the asynchronous message passing. If the producer sends messages i.e. create new elements in the stream, in a faster rate than the consumer can consume, increasingly more buffering will be needed until the system starts to break down.<A href="node8.html#label51"><SUP>2</SUP></A> There are a number of ways to solve this problem. One is to create a bounded buffer between producers and consumers which we will discuss later. Another way is to change the thread execution speed (by changing the thread's priority) so that consumers get more time-slices than producers. </P><P>The modules <CODE>Thread</CODE> and <CODE>Property</CODE> provide a number of operations pertinent to threads. Some of these are summarized in <A href="node8.html#threadtable">Table&nbsp;8.1</A>. </P><P></P><DIV class="table" id="threadtable"><HR><P><A name="threadtable"></A></P></DIV><TABLE align="center" bgcolor="#f0f0e0"><TR valign="top"><TH><P>Procedure</P></TH><TH><P>Description</P></TH></TR><TR valign="top"><TD><P><CODE>{Thread<SPAN class="keyword">.</SPAN>state&nbsp;<SPAN class="keyword">+</SPAN>T&nbsp;?A}</CODE></P></TD><TD><P>Returns current state of <CODE>T</CODE></P></TD></TR><TR valign="top"><TD><P><CODE>{Thread<SPAN class="keyword">.</SPAN>suspend&nbsp;<SPAN class="keyword">+</SPAN>T}</CODE></P></TD><TD><P>Suspends <CODE>T</CODE></P></TD></TR><TR valign="top"><TD><P><CODE>{Thread<SPAN class="keyword">.</SPAN>resume&nbsp;<SPAN class="keyword">+</SPAN>T}</CODE></P></TD><TD><P>Resumes <CODE>T</CODE></P></TD></TR><TR valign="top"><TD><P><CODE>{Thread<SPAN class="keyword">.</SPAN>terminate&nbsp;<SPAN class="keyword">+</SPAN>T}</CODE></P></TD><TD><P>Terminates <CODE>T</CODE></P></TD></TR><TR valign="top"><TD><P><CODE>{Thread<SPAN class="keyword">.</SPAN>injectException&nbsp;<SPAN class="keyword">+</SPAN>T&nbsp;<SPAN class="keyword">+</SPAN>E}</CODE></P></TD><TD><P>Raises exception <CODE>E</CODE> in <CODE>T</CODE></P></TD></TR><TR valign="top"><TD><P><CODE>{Thread<SPAN class="keyword">.</SPAN>this&nbsp;<SPAN class="keyword">+</SPAN>T}</CODE></P></TD><TD><P>Returns the current thread <CODE>T</CODE></P></TD></TR><TR valign="top"><TD><P><CODE>{Thread<SPAN class="keyword">.</SPAN>setPriority&nbsp;<SPAN class="keyword">+</SPAN>T&nbsp;<SPAN class="keyword">+</SPAN>P}</CODE></P></TD><TD><P>Sets <CODE>T</CODE>'s priority</P></TD></TR><TR valign="top"><TD><P><CODE>{Thread<SPAN class="keyword">.</SPAN>setThisPriority&nbsp;<SPAN class="keyword">+</SPAN>P}</CODE></P></TD><TD><P>Sets current thread's priority</P></TD></TR><TR valign="top"><TD><P><CODE>{Property<SPAN class="keyword">.</SPAN>get&nbsp;priorities&nbsp;?Pr&nbsp;}</CODE></P></TD><TD><P>Gets system-priority ratios </P></TD></TR><TR valign="top"><TD><P><CODE>{Property<SPAN class="keyword">.</SPAN>put&nbsp;priorities(high:<SPAN class="keyword">+</SPAN>X&nbsp;medium:<SPAN class="keyword">+</SPAN>Y)}</CODE></P></TD><TD><P>Sets system-priority ratios</P></TD></TR></TABLE><DIV class="table"><P class="caption"><STRONG>Table&nbsp;8.1:</STRONG> Thread operations</P><HR></DIV><P> </P><P>Oz has three priority levels. The system procedure </P><BLOCKQUOTE class="code"><CODE>{Property<SPAN class="keyword">.</SPAN>put&nbsp;priorities(high:X&nbsp;medium:Y)}</CODE></BLOCKQUOTE><P> </P><P>sets the processor-time ratio to <CODE>X:1</CODE> between high-priority threads and medium-priority thread. It also sets the processor-time ratio to <CODE>Y:1</CODE> between medium-priority threads and low-priority thread. <CODE>X</CODE> and <CODE>Y</CODE> are integers. So, if we execute </P><BLOCKQUOTE class="code"><CODE>{Property<SPAN class="keyword">.</SPAN>put&nbsp;priorities(high:10&nbsp;medium:10)}</CODE></BLOCKQUOTE><P> </P><P>for each <CODE>10</CODE> time-slices allocated to runnable high-priority threads, the system will allocate one time-slice for medium-priority threads, and similarly between medium and low priority threads. Within the same priority level, scheduling is fair and round-robin. Now let us make our producer-consumer program work. We give the producer low priority, and the consumer high. We also set the priority ratios to <CODE>10:1</CODE> and <CODE>10:1</CODE>. </P><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">local</SPAN>&nbsp;L&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{Property<SPAN class="keyword">.</SPAN>put&nbsp;threads&nbsp;priorities(high:10&nbsp;medium:10)}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Thread<SPAN class="keyword">.</SPAN>setThisPriority&nbsp;low}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L&nbsp;=&nbsp;{Producer&nbsp;5000000}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Thread<SPAN class="keyword">.</SPAN>setThisPriority&nbsp;high}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Consumer&nbsp;L}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;</CODE></BLOCKQUOTE><P> </P></DIV><DIV id="section.concurrency.demanddriven"><H2><A name="section.concurrency.demanddriven">8.4 Demand-driven Execution</A></H2><P>An extreme alternative solution is to make the producer lazy, only producing an item when the consumer requests one. A consumer, in this case, constructs the stream with unbound variables (empty boxes). The producer waits for the unbound variables (empty boxes) to appear on the stream. It then binds the variables (fills the boxes). The general pattern of the producer is as follows. </P><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Producer</SPAN>&nbsp;Xs}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;Xs&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;X<SPAN class="keyword">|</SPAN>Xr&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<SPAN class="string">'Produce&nbsp;I'</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X=I&nbsp;<SPAN class="keyword">...</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Producer&nbsp;Xr}&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><P> </P><P>The general pattern of the consumer is as follows. </P><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Consumer</SPAN>&nbsp;<SPAN class="keyword">...</SPAN>&nbsp;Xs}<BR>&nbsp;&nbsp;&nbsp;X&nbsp;Xr&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">...</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Xs&nbsp;=&nbsp;X<SPAN class="keyword">|</SPAN>Xr&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="string">'Consume&nbsp;X'</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">...</SPAN>&nbsp;{Consumer&nbsp;<SPAN class="keyword">...</SPAN>&nbsp;Xr}<BR><SPAN class="keyword">end</SPAN>&nbsp;&nbsp;</CODE></BLOCKQUOTE><P> </P><P>The program shown in <A href="node8.html#volvos2">Figure&nbsp;8.8</A> is a demand driven version of the program in <A href="node8.html#volvos">Figure&nbsp;8.7</A>. You can run it with very large number of volvo's! </P><P></P><DIV class="figure" id="volvos2"><HR><P><A name="volvos2"></A></P></DIV><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">local</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Producer</SPAN>&nbsp;Xs}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;Xs&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;X<SPAN class="keyword">|</SPAN>Xr&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;X&nbsp;=&nbsp;volvo&nbsp;{Producer&nbsp;Xr}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Browse&nbsp;<SPAN class="string">'end&nbsp;of&nbsp;line'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Consumer</SPAN>&nbsp;N&nbsp;Xs}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;N<SPAN class="keyword">=&lt;</SPAN>0&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;Xs=nil<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;X<SPAN class="keyword">|</SPAN>Xr&nbsp;=&nbsp;Xs&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;X&nbsp;<SPAN class="keyword">==</SPAN>&nbsp;volvo&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;N&nbsp;<SPAN class="keyword">mod</SPAN>&nbsp;1000&nbsp;<SPAN class="keyword">==</SPAN>&nbsp;0&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Browse&nbsp;<SPAN class="string">'riding&nbsp;a&nbsp;new&nbsp;volvo'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Consumer&nbsp;N<SPAN class="keyword">-</SPAN>1&nbsp;Xr}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Consumer&nbsp;N&nbsp;Xr}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{Consumer&nbsp;10000000&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Producer&nbsp;$}&nbsp;<SPAN class="keyword">end</SPAN>}<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><DIV class="figure"><P class="caption"><STRONG>Figure&nbsp;8.8:</STRONG> Producing Volvo's lazily</P><HR></DIV><P> </P><H3><A name="label49">8.4.1  Futures </A></H3><P>There is another way to program demand-driven computations. This uses the notion of <EM> future </EM> and the <CODE>ByNeed</CODE> primitive operation. A future is a read-only capability of a logic variable. For example to create a future of the variable <CODE>X</CODE> we perform the operation <CODE><SPAN class="keyword">!!</SPAN></CODE> to create a future <CODE>Y</CODE>. </P><BLOCKQUOTE class="code"><CODE>&nbsp;Y&nbsp;=&nbsp;<SPAN class="keyword">!!</SPAN>X&nbsp;</CODE></BLOCKQUOTE><P> </P><P> A thread trying to use the value of a future, e.g. using <CODE>Y</CODE>, will suspend until the variable of the future, e.g. <CODE>X</CODE>, gets bound. </P><P>One way to execute a procedure lazily, i.e. in a demand-driven manner, is to use the operation <CODE>{ByNeed&nbsp;<SPAN class="keyword">+</SPAN>P&nbsp;?F}</CODE>. <CODE>ByNeed</CODE> takes a one-argument procedure <CODE>P</CODE>, and returns a future <CODE>F</CODE>. When a thread tries to access the value of <CODE>F</CODE>, the procedure <CODE>{P&nbsp;X}</CODE> is called, and its result value <CODE>X</CODE> is bound to <CODE>F</CODE>. This allows us to perform demand-driven computations in a straightforward manner. For example by feeding </P><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">declare</SPAN>&nbsp;Y<BR>{ByNeed&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;X}&nbsp;X=1&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;Y}<BR>{Browse&nbsp;Y}</CODE></BLOCKQUOTE><P> </P><P>we will observe that <CODE>Y</CODE> becomes a future, i.e. we will see <CODE>Y<SPAN class="keyword">&lt;</SPAN>Future<SPAN class="keyword">&gt;</SPAN></CODE> in the Browser. If we try to access the value of <CODE>Y</CODE>, it will get bound to <CODE>1</CODE>. One way to access <CODE>Y</CODE> is by performing the operation <CODE>{Wait&nbsp;Y}</CODE> which triggers the producing procedure. </P><P> Now we can rewrite program of <A href="node8.html#volvos2">Figure&nbsp;8.8</A> as shown in <A href="node8.html#volvos3">Figure&nbsp;8.9</A>. This looks very similar to <A href="node8.html#volvos">Figure&nbsp;8.7</A> </P><DIV class="figure" id="volvos3"><HR><P><A name="volvos3"></A></P></DIV><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">local</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Producer</SPAN>&nbsp;Xs}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Xr&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Xs&nbsp;=&nbsp;volvo<SPAN class="keyword">|</SPAN>{ByNeed&nbsp;{Producer&nbsp;Xr}&nbsp;$}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Consumer</SPAN>&nbsp;N&nbsp;Xs}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;N<SPAN class="keyword">&gt;</SPAN>0&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;Xs&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;X<SPAN class="keyword">|</SPAN>Xr&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;X<SPAN class="keyword">==</SPAN>volvo&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;N&nbsp;<SPAN class="keyword">mod</SPAN>&nbsp;1000&nbsp;<SPAN class="keyword">==</SPAN>&nbsp;0&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Browse&nbsp;<SPAN class="string">'riding&nbsp;a&nbsp;new&nbsp;volvo'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Consumer&nbsp;N<SPAN class="keyword">-</SPAN>1&nbsp;Xr}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;{Consume&nbsp;N&nbsp;Xr}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{Consumer&nbsp;10000000&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Producer&nbsp;$}&nbsp;<SPAN class="keyword">end</SPAN>}<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><DIV class="figure"><P class="caption"><STRONG>Figure&nbsp;8.9:</STRONG> Producing Volvo's using <CODE>ByNeed</CODE> </P><HR></DIV><P> </P></DIV><DIV id="section.concurrency.termination"><H2><A name="section.concurrency.termination">8.5 Thread Termination-Detection</A></H2><P>We have seen how threads are forked using the statement <CODE><SPAN class="keyword">thread</SPAN>&nbsp;</CODE><I>S</I><CODE>&nbsp;<SPAN class="keyword">end</SPAN></CODE>. A natural question that arises is how to join back a forked thread into the original thread of control. In fact, this is a special case of detecting termination of multiple threads, and making another thread wait on that event. The general scheme is quite easy because Oz is a data-flow language. </P><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">thread</SPAN>&nbsp;</CODE><I>T1</I><CODE>&nbsp;</CODE><I>X1</I><CODE>=<SPAN class="keyword">unit</SPAN>&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">thread</SPAN>&nbsp;</CODE><I>T2</I><CODE>&nbsp;</CODE><I>X2</I><CODE>=</CODE><I>X1</I><CODE>&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">...</SPAN>&nbsp;<BR><SPAN class="keyword">thread</SPAN>&nbsp;</CODE><I>TN</I><CODE>&nbsp;</CODE><I>XN</I><CODE>=</CODE><I>XN-1</I><CODE>&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>{Wait&nbsp;</CODE><I>XN</I><CODE>}<BR></CODE><I>MainThread</I></BLOCKQUOTE><P> </P><P>When All threads terminate the variables <I>X1</I><CODE>&nbsp;<SPAN class="keyword">...</SPAN>&nbsp;</CODE><I>XN</I> will be merged together and bound to <CODE><SPAN class="keyword">unit</SPAN></CODE>. <CODE>{Wait&nbsp;</CODE><I>XN</I><CODE>}</CODE> suspends the main thread until <I>XN</I> is bound. </P><P>In <A href="node8.html#concurrentcomp">Figure&nbsp;8.10</A> we define a higher-order construct (combinator), that implements the concurrent-composition control construct that has been outlined above. It takes a single argument that is a list of nullary procedures. When it is executed, the procedures are forked concurrently. The next statement is executed only when all procedures in the list terminate. </P><P></P><DIV class="figure" id="concurrentcomp"><HR><P><A name="concurrentcomp"></A></P></DIV><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">local</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Conc1</SPAN>&nbsp;Ps&nbsp;I&nbsp;O}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;Ps&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;P<SPAN class="keyword">|</SPAN>Pr&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;M&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{P}&nbsp;M&nbsp;=&nbsp;I&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Conc1&nbsp;Pr&nbsp;M&nbsp;O}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;O&nbsp;=&nbsp;I<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Conc</SPAN>&nbsp;Ps}&nbsp;{Wait&nbsp;{Conc1&nbsp;Ps&nbsp;<SPAN class="keyword">unit</SPAN>&nbsp;$}}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><DIV class="figure"><P class="caption"><STRONG>Figure&nbsp;8.10:</STRONG> Concurrent Composition</P><HR></DIV><P></P><P> The program <A href="node8.html#pingpong1">Figure&nbsp;8.5</A> didn't terminate properly when the <CODE>Ping</CODE> and the <CODE>Pong</CODE> threads terminated. This problem can be remedied now. If we use <CODE>Application<SPAN class="keyword">.</SPAN>exit<SPAN class="keyword">/</SPAN>1</CODE> a stand-alone application terminates aborting remaining threads. We can arrange things such that the main thread terminates only when the <CODE>Ping</CODE> and the <CODE>Pong</CODE> threads terminate. This is shown in <A href="node8.html#pingpong2">Figure&nbsp;8.11</A>. </P><P></P><DIV class="figure" id="pingpong2"><HR><P><A name="pingpong2"></A></P></DIV><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">functor</SPAN>&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Browser(browse:Browse)&nbsp;%<SPAN class="comment">Import&nbsp;Browse&nbsp;form&nbsp;Browser&nbsp;module<BR></SPAN>&nbsp;&nbsp;&nbsp;Application<BR><SPAN class="keyword">define</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Ping</SPAN>&nbsp;N}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;N<SPAN class="keyword">==</SPAN>0&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Browse&nbsp;<SPAN class="string">'ping&nbsp;terminated'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;{Delay&nbsp;500}&nbsp;{Browse&nbsp;ping}&nbsp;{Ping&nbsp;N<SPAN class="keyword">-</SPAN>1}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Pong</SPAN>&nbsp;N}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{For&nbsp;1&nbsp;N&nbsp;1&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;I}&nbsp;{Delay&nbsp;600}&nbsp;{Browse&nbsp;pong}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Browse&nbsp;<SPAN class="string">'pong&nbsp;terminated'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;X1&nbsp;X2<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{Browse&nbsp;<SPAN class="string">'game&nbsp;started'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Ping&nbsp;50}&nbsp;X1=<SPAN class="keyword">unit</SPAN>&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Pong&nbsp;50}&nbsp;X2=X1&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{Wait&nbsp;X2}<BR>&nbsp;&nbsp;&nbsp;{Application<SPAN class="keyword">.</SPAN>exit&nbsp;0}<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><DIV class="figure"><P class="caption"><STRONG>Figure&nbsp;8.11:</STRONG> A 'Ping Pong' program stand-alone</P><HR></DIV><P></P></DIV></DIV><TABLE align="center" border="0" cellpadding="6" cellspacing="6" class="nav"><TR bgcolor="#DDDDDD"><TD><A href="node7.html#chapter.modules">&lt;&lt; Prev</A></TD><TD><A href="index.html">- Up -</A></TD><TD><A href="node9.html#chapter.stateful">Next &gt;&gt;</A></TD></TR></TABLE><HR align="left" width="30%"><DIV class="footnote"><A name="label50">1. </A>To terminate this program in the OS shell you have to type CONTROL-C. We will see later how to terminate it properly.</DIV><DIV class="footnote"><A name="label51">2. </A>Ironically in the Mozart system, using the distributed programming capabilities, stream communication across sites works better because of designed flow control mechanism that suspends producers when the network buffers are full.</DIV><HR><ADDRESS><A href="http://www.sics.se/~seif">Seif&nbsp;Haridi</A> and&nbsp;<A href="http://www.sics.se/~nilsf">Nils&nbsp;Franzn</A><BR><SPAN class="version">Version 1.4.0 (20080702)</SPAN></ADDRESS></BODY></HTML>
